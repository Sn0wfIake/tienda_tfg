 <html lang="es">
<meta charset="UTF-8">
<head>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/indexCss.css') }}">


  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>


<script>
  
const jsonData = (function () {
    var result;
    $.ajax({
      type: 'GET',
      url: 'http://127.0.0.1:5000/listacatalogo',
      dataType: 'json',
      data: 'prendas',
      async: false,
      success: function (data) {
        result = data;
      }
    });
    return result;
  })();

  const baseDeDatos  = jsonData;
</script>

  <!--Barra de navegacion-->
  <nav class="navbar navbar-toggleable-md navbar-light bg-light">
    <div class="container">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNav1"
        aria-controls="navbarNav1" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="#">
        <strong>SnowClothes</strong>
      </a>
      <div class="collapse navbar-collapse" id="navbarNav1">
        <ul class="navbar-nav mr-auto">

         <li class="nav-item">
            <a href="/catalogo" class="nav-link">Ver todo</a>
          </li>

        </ul>

      </div>
    </div>
  </nav>

</head>

<body>

  <!--Main layout-->
  <div class="container">
    <div class="row">

      <!--Sidebar-->
      <div class="col-lg-4 wow fadeIn" data-wow-delay="0.2s">

        <div class="widget-wrapper">
          <h4>Categorias:</h4>
          <br>
          <div class="list-group">
            <a href="/mujeres" class="list-group-item active">Mujer</a>
            <a href="/hombres" class="list-group-item">Hombre</a>
            <a href="/nenes" class="list-group-item">Niños</a>

          </div>
        </div>

        <div class="widget-wrapper wow fadeIn" data-wow-delay="0.4s">
          <h4>BIENVENIDO DE NUEVO!</h4>
          <br>
          <div class="card">
            <div class="card-block">
              <b>
            Bienvenido: {{session.user}}
                </b>
              </br></br></br>
                <a href="{{ url_for('logout') }}" class="btn btn btn-danger">Logout</a>

               
                  <aside class="">
                    <h2>Carrito</h2>
                    <!-- Elementos del carrito -->
                    <ul id="carrito" class="list-group"></ul>
                    <hr>
                    <!-- Precio total -->
                    <p class="text-right">Total: <span id="total">0.00</span>€</p>
                    <button id="boton-vaciar" class="btn btn-danger">Vaciar</button>
                    <button onclick="enviarDatosBackend ()" id="boton-vaciar" class="btn btn-success">Comprar todo</button>
                  </aside>
                 
               
            </div>

          </div>
        </div>

      </div>
      <!--/.Sidebar-->

      <!--Main column-->
      <div class="col-lg-8">

        <!--First row-->
        <div class="row wow fadeIn" data-wow-delay="0.4s">
          <div class="col-lg-12">
            <div class="divider-new">
              <h2 class="h2-responsive">Nuestra tienda:</h2>
            </div>


            <!--el carrusel-->
            <div id="carousel-example-1z" class="carousel slide carousel-fade" data-ride="carousel">

              <ol class="carousel-indicators">
                <li data-target="#carousel-example-1z" data-slide-to="0" class="active"></li>
                <li data-target="#carousel-example-1z" data-slide-to="1"></li>
                <li data-target="#carousel-example-1z" data-slide-to="2"></li>
              </ol>
              <div class="carousel-inner" role="listbox">
                <!--First slide-->
                <div class="carousel-item active">
                  <img src="https://thumbs.dreamstime.com/b/ca%C3%ADda-de-la-ropa-en-el-estante-de-la-ropa-90991990.jpg" alt="First slide" width="1321" height="583">
                  <div class="carousel-caption">

                    <h4>Promocion!</h4>
                    <br>
                  </div>
                </div>

                <!--Second slide-->
                <div class="carousel-item">
                  <img src="http://mdbootstrap.com/img//Photos/Slides/img%20(109).jpg" alt="Second slide" width="1321" height="583">
                  <div class="carousel-caption">
                    <h4>OFERTA</h4>
                    <br>
                  </div>
                </div>
                <!--/Second slide-->
                <!--Third slide-->
                <div class="carousel-item">
                  <img src="http://mdbootstrap.com/img//Photos/Slides/img%20(36).jpg" alt="Third slide" width="1321" height="583">
                  <div class="carousel-caption">
                    <h4>OFERTA</h4>
                    <br>
                  </div>
                </div>
                <!--/Third slide-->
              </div>

              <a class="carousel-control-prev" href="#carousel-example-1z" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
              </a>
              <a class="carousel-control-next" href="#carousel-example-1z" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
              </a>

            </div>

          </div>
        </div>
        <!--/.First row-->
        <br>
        <hr class="extra-margins">

        <!--Second row-->
        <div class="row">
          <!--First columnn-->
          <div class="col-lg-4">
            <!--Card-->
            <div class="card  wow fadeIn" data-wow-delay="0.6s">

              <!--Card image-->
              <div class="view overlay hm-white-slight">
                <img src="https://www.lavanguardia.com/files/og_thumbnail/uploads/2018/08/10/5fa4322e739b0.jpeg" width="322" height="203" class="img-fluid" alt="Error al cargar la imagen">
                <a href="#">
                  <div class="mask"></div>
                </a>
              </div>

              <div class="card-block">
                <a href="/nenes" class="btn btn-block">
                  <h4 class="card-title">Niños</h4>

                  <p class="card-text">Ropita para niños.</p>
                  <strong>Ver la ropa </strong>
                </a>
              </div>


            </div>

          </div>
          <!--First columnn-->

          <!--Second columnn-->
          <div class="col-lg-4">
            <!--Card-->
            <div class="card  wow fadeIn" data-wow-delay="0.6s">

              <!--Card image-->
              <div class="view overlay hm-white-slight">
                <img src="https://vader.news/__export/1619057905977/sites/gadgets/img/2021/04/21/the_office.jpg_2011917973.jpg" width="322" height="203" class="img-fluid" alt="Error al cargar la imagen" >
                <a href="#">
                  <div class="mask"></div>
                </a>
              </div>

              <div class="card-block">
                <a href="/hombres" class="btn btn-block">
                  <h4 class="card-title">Hombres</h4>

                  <p class="card-text">Ropa para hombres.</p>
                  <strong>Ver la ropa </strong>
                </a>
              </div>


            </div>

          </div>
          <!--Second columnn-->

          <!--Third columnn-->
          <div class="col-lg-4">
            <!--Card-->
            <div class="card  wow fadeIn" data-wow-delay="0.6s">

              <!--Card image-->
              <div class="view overlay hm-white-slight">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQDkohr2ZA-eCptXq0KzySGiKjB490Q6ExKTQ&usqp=CAU" width="322" height="203" class="img-fluid" alt="Error al cargar la imagen">
                <a href="#">
                  <div class="mask"></div>
                </a>
              </div>

              <div class="card-block">
                <a href="/mujeres" class="btn btn-block">
                  <h4 class="card-title">Mujeres</h4>

                  <p class="card-text">Ropa para mujeres.</p>
                  <strong>Ver la ropa </strong>
                </a>
              </div>


            </div>

          </div>

        </div>
        <div>
          <br><br>
        </div>

      </div>

    </div>
  </div>


</body>
<script>


document.addEventListener('DOMContentLoaded', () => {



let carrito = [];
const divisa = '€';
const DOMitems = document.querySelector('#items');
const DOMcarrito = document.querySelector('#carrito');
const DOMtotal = document.querySelector('#total');
const DOMbotonVaciar = document.querySelector('#boton-vaciar');

const miLocalStorage = window.localStorage;


function renderizarCarrito() {
  // Vaciamos todo el html
  DOMcarrito.textContent = '';
  // Quitamos los duplicados
  const carritoSinDuplicados = [...new Set(carrito)];
  // Generamos los Nodos a partir de carrito
  carritoSinDuplicados.forEach((item) => {
    // Obtenemos el item que necesitamos de la variable base de datos
    const miItem = baseDeDatos.filter((itemBaseDatos) => {
      // ¿Coincide las id? Solo puede existir un caso
      return itemBaseDatos.id_prenda === parseInt(item);
    });
    // Cuenta el número de veces que se repite el producto
    const numeroUnidadesItem = carrito.reduce((total, itemId) => {
      // ¿Coincide las id? Incremento el contador, en caso contrario no mantengo
      return itemId === item ? total += 1 : total;
    }, 0);
    // Creamos el nodo del item del carrito
    const miNodo = document.createElement('li');
    miNodo.classList.add('list-group-item', 'text-right', 'mx-2');
    miNodo.textContent = `${numeroUnidadesItem} x ${miItem[0].tipo_prenda} - ${miItem[0].precio}${divisa}`;
    // Boton de borrar
    const miBoton = document.createElement('button');
    miBoton.classList.add('btn', 'btn-danger', 'mx-5');
    miBoton.textContent = 'X';
    miBoton.style.marginLeft = '1rem';
    miBoton.dataset.item = item;
    miBoton.addEventListener('click', borrarItemCarrito);
    // Mezclamos nodos
    miNodo.appendChild(miBoton);
    DOMcarrito.appendChild(miNodo);
  });
  // Renderizamos el precio total en el HTML
  DOMtotal.textContent = calcularTotal();
}


function borrarItemCarrito(evento) {
  // Obtenemos el producto ID que hay en el boton pulsado
  const id = evento.target.dataset.item;
  // Borramos todos los productos
  carrito = carrito.filter((carritoId) => {
    return carritoId !== id;
  });
  // volvemos a renderizar
  renderizarCarrito();
  // Actualizamos el LocalStorage
  guardarCarritoEnLocalStorage();

}

/**
 * Calcula el precio total teniendo en cuenta los productos repetidos
 */
function calcularTotal() {
  // Recorremos el array del carrito 
  return carrito.reduce((total, item) => {
    // De cada elemento obtenemos su precio
    const miItem = baseDeDatos.filter((itemBaseDatos) => {
      return itemBaseDatos.id_prenda === parseInt(item);
    });
    // Los sumamos al total
    return total + miItem[0].precio;
  }, 0).toFixed(2);
}

/**
* Varia el carrito y vuelve a dibujarlo
*/
function vaciarCarrito() {
  // Limpiamos los productos guardados
  carrito = [];
  // Renderizamos los cambios
  renderizarCarrito();
  // Borra LocalStorage
  localStorage.clear();

}

function guardarCarritoEnLocalStorage() {
  miLocalStorage.setItem('carrito', JSON.stringify(carrito));
}

function cargarCarritoDeLocalStorage() {
  // ¿Existe un carrito previo guardado en LocalStorage?
  if (miLocalStorage.getItem('carrito') !== null) {
    // Carga la información
    carrito = JSON.parse(miLocalStorage.getItem('carrito'));
    

  }
}


DOMbotonVaciar.addEventListener('click', vaciarCarrito);

cargarCarritoDeLocalStorage();

renderizarCarrito();

});
function enviarDatosBackend() {
    const miLocalStorage = window.localStorage;

    if (miLocalStorage.getItem('carrito') !== null) {

      const enviarJson = JSON.parse(miLocalStorage.getItem('carrito'));
      console.log("json: " + enviarJson);

      $.ajax({

        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(enviarJson),
        url: 'http://127.0.0.1:5000/test',
        success: function (e) {
          console.log(e);
          localStorage.clear();
          window.location = "http://127.0.0.1:5000/exito";
    }});

    }
  }

</script>
</html>